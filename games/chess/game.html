<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess ‚Äì Online Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    :root {
      --bg: #050010;
      --panel: #0d0125;
      --neon: #00ffea;
      --hover: #ff00f2;
      --text: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background: radial-gradient(circle at top, #100030, #050010);
      color: var(--text);
      display: flex;
      flex-direction: row;
      padding: 20px;
      gap: 20px;
    }

    #board {
      width: 420px;
      border: 4px solid var(--neon);
      border-radius: 12px;
    }

    .panel {
      background: var(--panel);
      border: 2px solid var(--neon);
      border-radius: 12px;
      padding: 16px;
      max-width: 320px;
    }

    .panel h2 {
      margin-top: 0;
      color: var(--neon);
    }

    .panel button {
      font-family: inherit;
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      border: 2px solid var(--neon);
      background: transparent;
      color: var(--text);
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .panel button:hover {
      background: var(--neon);
      color: var(--bg);
      cursor: pointer;
    }

    .panel a {
      color: var(--neon);
      text-decoration: none;
    }

    .bad {
      color: #ff9e9e;
      word-wrap: break-word;
    }

    pre {
      background: #111;
      color: #9ad;
      padding: 8px;
      border-radius: 6px;
      overflow-wrap: break-word;
    }

    @media (max-width: 700px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      #board {
        width: 90%;
        max-width: 360px;
      }
    }
  </style>
</head>
<body>
  <div id="board"></div>

  <div class="panel">
    <h2 id="role">You: ‚Ä¶</h2>
    <div>Room: <code id="rid"></code></div>
    <div>Turn: <span id="turn">-</span></div>
    <div>Status: <span id="status">connecting...</span></div>
    <div style="margin:8px 0">
      <button id="reset">Reset</button>
      <button id="copy">Copy code</button>
    </div>
    <div class="bad" id="msg"></div>
    <div style="margin-top:12px">
      <a href="./">‚Üê Back to Room</a>
    </div>
    <details style="margin-top:16px">
      <summary>Debug</summary>
      <div>FEN:</div>
      <pre id="fen"></pre>
    </details>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/chess.js@1.0.0/dist/chess.min.js"></script>
  <script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCzxY-72w17gULJHFAGb1dw1bjqNQhyJf8",
      authDomain: "gamehub-cff5c.firebaseapp.com",
      databaseURL: "https://gamehub-cff5c-default-rtdb.firebaseio.com",
      projectId: "gamehub-cff5c",
      storageBucket: "gamehub-cff5c.firebasestorage.app",
      messagingSenderId: "263144183071",
      appId: "1:263144183071:web:fae46eae43470f252d4c2a",
      measurementId: "G-L7SY3LWLVR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const $ = id => document.getElementById(id);
    const setText = (id, v) => $(id).textContent = v;
    const setMsg = m => setText('msg', m || '');

    // üß† Genera c√≥digo corto en min√∫sculas si no hay uno en la URL
    const params = new URLSearchParams(location.search);
    let roomId = params.get('g');

    if (!roomId) {
      roomId = Math.random().toString(36).substring(2, 7);
      window.location.search = '?g=' + roomId;
    }

    setText('rid', roomId);

    const game = new Chess();
    let myRole = null;
    const roomRef = db.ref('rooms/' + roomId);

    const board = Chessboard('board', {
      position: game.fen(),
      draggable: true,
      orientation: 'white',
      onDragStart: (src, piece) => {
        if (game.game_over()) return false;
        if (!myRole) return false;
        const myColor = myRole[0];
        if (game.turn() !== myColor) return false;
        if ((myColor === 'w' && piece.startsWith('b')) || (myColor === 'b' && piece.startsWith('w'))) return false;
      },
      onDrop: (src, tgt) => {
        const move = game.move({ from: src, to: tgt, promotion: 'q' });
        if (!move) return 'snapback';
        publishState();
      },
      onSnapEnd: () => board.position(game.fen(), true)
    });

    async function joinRoom() {
      const snap = await roomRef.get();
      if (!snap.exists()) {
        myRole = 'white';
        await roomRef.set({
          players: { white: true, black: null },
          fen: game.fen(),
          turn: game.turn(),
          updatedAt: Date.now()
        });
      } else {
        const data = snap.val() || {};
        if (data.players?.white && !data.players?.black) {
          myRole = 'black';
          await roomRef.child('players/black').set(true);
          board.orientation('black');
        } else if (!data.players?.white) {
          myRole = 'white';
          await roomRef.child('players/white').set(true);
        } else {
          myRole = null; // spectator
        }
        if (data.fen) game.load(data.fen);
        board.position(game.fen(), true);
      }
      updateUI();
      subscribeRoom();
    }

    function subscribeRoom() {
      roomRef.on('value', (snap) => {
        const v = snap.val();
        if (!v) return;
        if (v.fen && v.fen !== game.fen()) {
          game.load(v.fen);
          board.position(v.fen, true);
        }
        if (v.turn) setText('turn', v.turn === 'w' ? 'white' : 'black');
        updateStatus();
      });
    }

    let writeBusy = false;
    async function publishState() {
      if (writeBusy) return;
      writeBusy = true;
      try {
        await roomRef.update({
          fen: game.fen(),
          turn: game.turn(),
          updatedAt: Date.now()
        });
        updateUI();
      } finally {
        writeBusy = false;
      }
    }

    function updateStatus() {
      let status = '';
      if (game.in_checkmate()) status = 'checkmate';
      else if (game.in_draw()) status = 'draw';
      else if (game.in_check()) status = 'check';
      else status = 'playing';
      setText('status', status);
      setText('fen', game.fen());
    }

    function updateUI() {
      setText('role', 'You: ' + (myRole || 'spectator'));
      setText('turn', game.turn() === 'w' ? 'white' : 'black');
      updateStatus();
    }

    $('reset').onclick = async () => {
      game.reset();
      board.start();
      await publishState();
      setMsg('');
    };

    // üìã Copia solo el c√≥digo
    $('copy').onclick = async () => {
      try {
        await navigator.clipboard.writeText(roomId);
        setMsg('Code copied: ' + roomId);
      } catch {
        setMsg('Copy failed');
      }
      setTimeout(() => setMsg(''), 2000);
    };

    joinRoom();
    window.addEventListener('resize', board.resize);
  </script>
</body>
</html>
